<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Seguimiento de Transporte</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        #map {
            height: 400px;
            width: 100%;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-blue-100 min-h-screen">
    <div id="app"></div>

    <script>
        // Configuraci√≥n JSONBin - Base de datos gratuita sin registro
        const API_KEY = '$2a$10$fbCvZZu9kUDvsz8wrbmLNuTJFgwR.ULSNa.P9Lk3u15wSKEP.NLJW';
        const BIN_ID = '68ffd4f8d0ea881f40c06ed1'; // Se crear√° autom√°ticamente

        var appState = {
            view: 'admin',
            userType: 'admin',
            trackingId: '',
            binId: BIN_ID,
            newTracking: {
                vehiculo: '',
                chofer: '',
                logoUrl: '',
                horaInicio: '',
                horaFin: ''
            },
            isTracking: false,
            currentPosition: null,
            routeHistory: [],
            stops: [],
            watchId: null,
            mapObj: null,
            marker: null,
            routeLine: null,
            stopMarkers: []
        };

        function generateTrackingId() {
            return 'track_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        async function getAllTrackings() {
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${appState.binId}/latest`, {
                    headers: {
                        'X-Master-Key': API_KEY
                    }
                });
                if (response.ok) {
                    const data = await response.json();
                    return data.record.trackings || {};
                }
                return {};
            } catch (error) {
                console.log('Creando nueva base de datos...');
                return {};
            }
        }

        async function saveAllTrackings(trackings) {
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${appState.binId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': API_KEY
                    },
                    body: JSON.stringify({ trackings: trackings })
                });
                return response.ok;
            } catch (error) {
                console.error('Error al guardar:', error);
                return false;
            }
        }

        async function createTracking() {
            if (!appState.newTracking.vehiculo || !appState.newTracking.chofer) {
                alert('Por favor completa los campos de Veh√≠culo y Chofer');
                return;
            }

            var id = generateTrackingId();
            var trackingData = {
                vehiculo: appState.newTracking.vehiculo,
                chofer: appState.newTracking.chofer,
                logoUrl: appState.newTracking.logoUrl,
                horaInicio: appState.newTracking.horaInicio,
                horaFin: appState.newTracking.horaFin,
                id: id,
                createdAt: new Date().toISOString(),
                routeHistory: [],
                stops: [],
                active: false
            };

            try {
                const allTrackings = await getAllTrackings();
                allTrackings[id] = trackingData;
                const saved = await saveAllTrackings(allTrackings);
                
                if (saved) {
                    appState.trackingId = id;
                    render();
                    alert('Seguimiento creado exitosamente!');
                } else {
                    alert('Error al crear el seguimiento. Verifica la configuraci√≥n.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            }
        }

        async function saveTrackingData() {
            if (!appState.trackingId) return;

            try {
                const allTrackings = await getAllTrackings();
                if (allTrackings[appState.trackingId]) {
                    allTrackings[appState.trackingId].routeHistory = appState.routeHistory;
                    allTrackings[appState.trackingId].currentPosition = appState.currentPosition;
                    allTrackings[appState.trackingId].active = appState.isTracking;
                    allTrackings[appState.trackingId].stops = appState.stops;
                    allTrackings[appState.trackingId].lastUpdate = new Date().toISOString();
                    await saveAllTrackings(allTrackings);
                }
            } catch (error) {
                console.error('Error al guardar datos:', error);
            }
        }

        async function loadTrackingData() {
            if (!appState.trackingId) return;

            try {
                const allTrackings = await getAllTrackings();
                const data = allTrackings[appState.trackingId];
                
                if (data) {
                    appState.newTracking = {
                        vehiculo: data.vehiculo || '',
                        chofer: data.chofer || '',
                        logoUrl: data.logoUrl || '',
                        horaInicio: data.horaInicio || '',
                        horaFin: data.horaFin || ''
                    };
                    appState.routeHistory = data.routeHistory || [];
                    appState.stops = data.stops || [];
                    appState.currentPosition = data.currentPosition || null;
                    appState.isTracking = data.active || false;
                }
            } catch (error) {
                console.error('Error al cargar datos:', error);
            }
        }

        function initMap() {
            setTimeout(function() {
                if (document.getElementById('map') && !appState.mapObj) {
                    appState.mapObj = L.map('map').setView([-34.6037, -58.3816], 13);
                    
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap'
                    }).addTo(appState.mapObj);

                    if (appState.currentPosition) {
                        updateMap();
                    }
                }
            }, 100);
        }

        function updateMap() {
            if (!appState.mapObj) return;

            if (appState.currentPosition) {
                var lat = appState.currentPosition.lat;
                var lng = appState.currentPosition.lng;

                if (appState.marker) {
                    appState.marker.setLatLng([lat, lng]);
                } else {
                    var truckIcon = L.divIcon({
                        html: '<div style="font-size: 30px;">üöõ</div>',
                        className: 'truck-marker',
                        iconSize: [30, 30]
                    });
                    appState.marker = L.marker([lat, lng], {icon: truckIcon}).addTo(appState.mapObj);
                }

                appState.mapObj.setView([lat, lng], 15);
            }

            if (appState.routeHistory.length > 1) {
                var routeCoords = [];
                for (var i = 0; i < appState.routeHistory.length; i++) {
                    routeCoords.push([appState.routeHistory[i].lat, appState.routeHistory[i].lng]);
                }

                if (appState.routeLine) {
                    appState.routeLine.setLatLngs(routeCoords);
                } else {
                    appState.routeLine = L.polyline(routeCoords, {
                        color: 'blue',
                        weight: 4,
                        opacity: 0.7
                    }).addTo(appState.mapObj);
                }
            }

            for (var i = 0; i < appState.stopMarkers.length; i++) {
                appState.mapObj.removeLayer(appState.stopMarkers[i]);
            }
            appState.stopMarkers = [];

            for (var i = 0; i < appState.stops.length; i++) {
                if (appState.stops[i].position) {
                    var stopIcon = L.divIcon({
                        html: '<div style="background: red; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-weight: bold;">' + (i + 1) + '</div>',
                        className: 'stop-marker',
                        iconSize: [25, 25]
                    });
                    var stopMarker = L.marker([appState.stops[i].position.lat, appState.stops[i].position.lng], {icon: stopIcon})
                        .addTo(appState.mapObj)
                        .bindPopup('Parada ' + (i + 1));
                    appState.stopMarkers.push(stopMarker);
                }
            }
        }

        function toggleTracking() {
            appState.isTracking = !appState.isTracking;

            if (appState.isTracking) {
                if (navigator.geolocation) {
                    appState.watchId = navigator.geolocation.watchPosition(
                        function(position) {
                            var newPos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                                timestamp: new Date().toISOString()
                            };
                            appState.currentPosition = newPos;
                            appState.routeHistory.push(newPos);
                            saveTrackingData();
                            updateMap();
                            render();
                        },
                        function(error) {
                            console.error('Error:', error);
                            alert('Error al obtener la ubicaci√≥n. Aseg√∫rate de haber dado permisos.');
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 5000,
                            maximumAge: 0
                        }
                    );
                } else {
                    alert('Tu navegador no soporta geolocalizaci√≥n');
                    appState.isTracking = false;
                }
            } else {
                if (appState.watchId) {
                    navigator.geolocation.clearWatch(appState.watchId);
                    appState.watchId = null;
                }
            }

            saveTrackingData();
            render();
        }

        function addStop() {
            var stop = {
                position: appState.currentPosition,
                timestamp: new Date().toISOString(),
                duration: 0
            };
            appState.stops.push(stop);
            saveTrackingData();
            updateMap();
            render();
        }

        function getDriverLink() {
            var baseUrl = window.location.origin + window.location.pathname;
            return baseUrl + '?tracking=' + appState.trackingId + '&type=driver';
        }

        function getClientLink() {
            var baseUrl = window.location.origin + window.location.pathname;
            return baseUrl + '?tracking=' + appState.trackingId + '&type=client';
        }

        function copyDriverLink() {
            var link = getDriverLink();
            navigator.clipboard.writeText(link).then(function() {
                alert('Link del CHOFER copiado!\n\nEnv√≠a este link al chofer por WhatsApp.\n\n' + link);
            }).catch(function() {
                prompt('Copia este link para el CHOFER:', link);
            });
        }

        function copyClientLink() {
            var link = getClientLink();
            navigator.clipboard.writeText(link).then(function() {
                alert('Link del CLIENTE copiado!\n\nEnv√≠a este link al cliente por WhatsApp.\n\n' + link);
            }).catch(function() {
                prompt('Copia este link para el CLIENTE:', link);
            });
        }

        function formatTime(isoString) {
            var date = new Date(isoString);
            return date.toLocaleTimeString('es-AR');
        }

        function handleCreateTracking() {
            appState.newTracking.vehiculo = document.getElementById('vehiculo').value;
            appState.newTracking.chofer = document.getElementById('chofer').value;
            appState.newTracking.logoUrl = document.getElementById('logoUrl').value;
            appState.newTracking.horaInicio = document.getElementById('horaInicio').value;
            appState.newTracking.horaFin = document.getElementById('horaFin').value;
            createTracking();
        }

        async function goToDriverView() {
            appState.userType = 'driver';
            appState.view = 'tracking';
            await loadTrackingData();
            render();
            initMap();
        }

        async function goToClientView() {
            appState.userType = 'client';
            appState.view = 'tracking';
            await loadTrackingData();
            render();
            initMap();
        }

        function goToAdmin() {
            appState.view = 'admin';
            appState.userType = 'admin';
            window.history.pushState({}, '', window.location.pathname);
            render();
        }

        function render() {
            var app = document.getElementById('app');
            var html = '';

            if (appState.view === 'admin') {
                if (!appState.trackingId) {
                    html = '<div class="max-w-4xl mx-auto p-4"><div class="bg-white rounded-lg shadow-lg p-6">' +
                        '<h1 class="text-3xl font-bold text-blue-900 mb-6">üöõ Panel de Administraci√≥n</h1>' +
                        '<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4 text-sm">' +
                        '<p class="font-semibold text-yellow-800 mb-1">‚ö†Ô∏è Configuraci√≥n Requerida</p>' +
                        '<p class="text-yellow-700">Necesitas configurar tu base de datos JSONBin. <a href="#" onclick="alert(\'1. Ve a jsonbin.io\\n2. Crea una cuenta gratis\\n3. Crea un nuevo Bin\\n4. Copia tu API Key y Bin ID\\n5. Reempl√°zalos en las l√≠neas 18-19 del c√≥digo\'); return false;" class="underline">Ver instrucciones</a></p>' +
                        '</div>' +
                        '<h2 class="text-xl font-semibold text-gray-700 mb-4">Crear Nuevo Seguimiento</h2>' +
                        '<div class="space-y-4">' +
                        '<div><label class="block text-sm font-medium text-gray-700 mb-1">Veh√≠culo *</label>' +
                        '<input type="text" id="vehiculo" placeholder="Ej: Cami√≥n Mercedes Benz - ABC123" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>' +
                        '<div><label class="block text-sm font-medium text-gray-700 mb-1">Chofer *</label>' +
                        '<input type="text" id="chofer" placeholder="Ej: Juan P√©rez" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>' +
                        '<div><label class="block text-sm font-medium text-gray-700 mb-1">URL del Logo (opcional)</label>' +
                        '<input type="text" id="logoUrl" placeholder="https://ejemplo.com/logo.png" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>' +
                        '<div class="grid grid-cols-2 gap-4">' +
                        '<div><label class="block text-sm font-medium text-gray-700 mb-1">Hora Inicio</label>' +
                        '<input type="time" id="horaInicio" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>' +
                        '<div><label class="block text-sm font-medium text-gray-700 mb-1">Hora Fin</label>' +
                        '<input type="time" id="horaFin" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>' +
                        '</div>' +
                        '<button onclick="handleCreateTracking()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700">Crear Seguimiento</button>' +
                        '</div></div></div>';
                } else {
                    html = '<div class="max-w-4xl mx-auto p-4"><div class="bg-white rounded-lg shadow-lg p-6">' +
                        '<h1 class="text-3xl font-bold text-blue-900 mb-6">üöõ Panel de Administraci√≥n</h1>' +
                        '<div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">' +
                        '<h3 class="font-semibold text-green-900 mb-3">‚úÖ Seguimiento Creado</h3>' +
                        '<p class="text-sm text-green-700 mb-4">ID: ' + appState.trackingId + '</p>' +
                        '<div class="space-y-3">' +
                        '<div class="bg-white rounded-lg p-3 border border-green-300">' +
                        '<div class="flex items-center justify-between mb-2"><span class="font-semibold text-gray-900">üöó Link para el CHOFER</span></div>' +
                        '<p class="text-xs text-gray-600 mb-2">El chofer usa este link para activar GPS y registrar paradas</p>' +
                        '<button onclick="copyDriverLink()" class="w-full bg-orange-600 text-white py-2 rounded-lg font-semibold hover:bg-orange-700">üì§ Copiar Link del Chofer</button>' +
                        '</div>' +
                        '<div class="bg-white rounded-lg p-3 border border-green-300">' +
                        '<div class="flex items-center justify-between mb-2"><span class="font-semibold text-gray-900">üë§ Link para el CLIENTE</span></div>' +
                        '<p class="text-xs text-gray-600 mb-2">El cliente usa este link solo para VER el seguimiento</p>' +
                        '<button onclick="copyClientLink()" class="w-full bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700">üì§ Copiar Link del Cliente</button>' +
                        '</div></div></div>' +
                        '<div class="flex gap-2">' +
                        '<button onclick="goToDriverView()" class="flex-1 bg-orange-600 text-white py-2 rounded-lg font-semibold hover:bg-orange-700">üëÅÔ∏è Vista Chofer</button>' +
                        '<button onclick="goToClientView()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700">üëÅÔ∏è Vista Cliente</button>' +
                        '</div></div></div>';
                }
            } else if (appState.userType === 'driver') {
                var logo = appState.newTracking.logoUrl ? '<div class="bg-blue-900 p-6 flex justify-center"><img src="' + appState.newTracking.logoUrl + '" alt="Logo" class="h-16 object-contain"></div>' : '';
                var mapDiv = appState.currentPosition ? '<div class="mb-4"><h3 class="font-semibold text-gray-900 mb-2">üìç Tu Ubicaci√≥n</h3><div id="map"></div></div>' : '';
                var posInfo = appState.currentPosition ? '<div class="bg-gray-50 rounded-lg p-4 mb-4"><p class="text-sm text-gray-600">Posici√≥n:</p><p class="font-mono text-sm">Lat: ' + appState.currentPosition.lat.toFixed(6) + ', Lng: ' + appState.currentPosition.lng.toFixed(6) + '</p><p class="text-xs text-gray-500 mt-1">' + formatTime(appState.currentPosition.timestamp) + '</p></div>' : '';
                var stopBtn = appState.isTracking ? '<button onclick="addStop()" class="bg-yellow-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-yellow-700">üìç Registrar Parada</button>' : '';
                
                html = '<div class="max-w-4xl mx-auto p-4"><div class="bg-white rounded-lg shadow-lg overflow-hidden">' + logo +
                    '<div class="p-6"><h1 class="text-2xl font-bold text-gray-900 mb-6">üöó Panel del Chofer</h1>' +
                    '<div class="bg-orange-50 rounded-lg p-4 mb-4"><p class="font-semibold">Veh√≠culo: ' + appState.newTracking.vehiculo + '</p><p class="text-sm">Chofer: ' + appState.newTracking.chofer + '</p></div>' +
                    '<div class="flex gap-2 mb-4">' +
                    '<button onclick="toggleTracking()" class="flex-1 py-4 rounded-lg font-semibold text-lg ' + (appState.isTracking ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700') + ' text-white">' +
                    (appState.isTracking ? '‚è∏Ô∏è Detener' : '‚ñ∂Ô∏è Iniciar') + '</button>' + stopBtn +
                    '</div>' + posInfo + mapDiv +
                    '</div></div><div class="mt-4 text-center"><button onclick="goToAdmin()" class="text-blue-600 hover:text-blue-800 text-sm font-medium">‚Üê Volver</button></div></div>';
            } else {
                var logo = appState.newTracking.logoUrl ? '<div class="bg-blue-900 p-6 flex justify-center"><img src="' + appState.newTracking.logoUrl + '" alt="Logo" class="h-16 object-contain"></div>' : '';
                var mapDiv = appState.currentPosition ? '<div class="mb-4"><h3 class="font-semibold text-gray-900 mb-2">üìç Ubicaci√≥n en Tiempo Real</h3><div id="map"></div></div>' : '';
                var status = appState.currentPosition ? '<div class="bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg p-4 mb-4"><div class="flex items-center gap-2 mb-2"><span class="text-2xl">üìç</span><span class="font-semibold text-lg">En Tr√°nsito</span></div><p class="text-sm opacity-90">√öltima actualizaci√≥n: ' + formatTime(appState.currentPosition.timestamp) + '</p></div>' : '<div class="bg-gray-50 border border-gray-200 rounded-lg p-8 text-center"><div class="text-6xl mb-4">üöõ</div><p class="text-gray-600">El seguimiento a√∫n no ha comenzado</p></div>';
                
                html = '<div class="max-w-4xl mx-auto p-4"><div class="bg-white rounded-lg shadow-lg overflow-hidden">' + logo +
                    '<div class="p-6"><h1 class="text-2xl font-bold text-gray-900 mb-6">Seguimiento de Env√≠o</h1>' +
                    '<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">' +
                    '<div class="bg-blue-50 rounded-lg p-4"><div class="flex items-center gap-2 text-blue-900 mb-2"><span class="text-xl">üöõ</span><span class="font-semibold">Veh√≠culo</span></div><p class="text-gray-700">' + appState.newTracking.vehiculo + '</p></div>' +
                    '<div class="bg-green-50 rounded-lg p-4"><div class="flex items-center gap-2 text-green-900 mb-2"><span class="text-xl">üë§</span><span class="font-semibold">Chofer</span></div><p class="text-gray-700">' + appState.newTracking.chofer + '</p></div>' +
                    '</div>' + status + mapDiv +
                    '</div></div><div class="mt-4 text-center"><button onclick="goToAdmin()" class="text-blue-600 hover:text-blue-800 text-sm font-medium">‚Üê Volver</button></div></div>';
            }

            app.innerHTML = html;
            
            if (appState.currentPosition && appState.view !== 'admin') {
                initMap();
            }
        }

        window.addEventListener('DOMContentLoaded', async function() {
            var params = new URLSearchParams(window.location.search);
            var urlTrackingId = params.get('tracking');
            var urlType = params.get('type');
            
            if (urlTrackingId) {
                appState.trackingId = urlTrackingId;
                appState.view = 'tracking';
                appState.userType = urlType || 'client';
                await loadTrackingData();
            }
            
            render();
            
            if (appState.view !== 'admin') {
                setInterval(async function() {
                    await loadTrackingData();
                    updateMap();
                    if (appState.userType === 'client') {
                        render();
                    }
                }, 5000);
            }
        });
    </script>
</body>
</html>
